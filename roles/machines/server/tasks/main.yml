- name: Import common
  ansible.builtin.import_role: { name: common }

- name: Import pacsync
  ansible.builtin.import_role: { name: pacsync }

- name: Import systemd-timesyncd
  ansible.builtin.import_role: { name: systemd_timesyncd }

# More secure SSH authentication
- name: Disable empty password login
  ansible.builtin.lineinfile:
    dest: /etc/ssh/sshd_config
    regexp: "^#?PermitEmptyPasswords"
    line: "PermitEmptyPasswords no"
  notify: Restart sshd

- name: Disable password login
  ansible.builtin.lineinfile:
    dest: /etc/ssh/sshd_config
    regexp: "^#?PasswordAuthentication"
    line: "PasswordAuthentication no"
  notify: Restart sshd

# Setup ZFS repo
- name: Add arch ZFS repo
  ansible.builtin.copy:
    src: archzfs-repo
    dest: /etc/pacman.d
    mode: "0644"

- name: Include archzfs repo in pacman.conf
  ansible.builtin.lineinfile:
    dest: /etc/pacman.conf
    line: "Include = /etc/pacman.d/archzfs-repo"
  notify: Sync pacman cache

- name: Install base packages
  community.general.pacman:
    name:
      - archzfs-linux
      - bash-completion
      - nfs-utils
      - nginx
      - rclone
      - rsync
      - transmission-cli
      - tailscale
      - podman

      # Required for encrypting the transmission basic auth password
      - python-passlib

# System configuration
- name: Import network tasks
  ansible.builtin.import_tasks: network.yml

- name: Import rclone tasks
  ansible.builtin.import_tasks: rclone.yml

- name: Import hardware tasks
  ansible.builtin.import_tasks: hardware.yml

# Services
- name: Import nfs tasks
  tags: [nfs]
  ansible.builtin.import_tasks: service-nfs.yml

- name: Import tailscale tasks
  tags: [tailscale]
  ansible.builtin.import_tasks: service-tailscale.yml

- name: Import nginx tasks
  tags: [nginx]
  ansible.builtin.import_tasks: service-nginx.yml

- name: Import transmission tasks
  tags: [transmission]
  ansible.builtin.import_tasks: service-transmission.yml

- name: Import home-assistant tasks
  tags: [hass]
  ansible.builtin.import_tasks: service-hass.yml

- name: Import waitress tasks
  tags: [waitress]
  ansible.builtin.import_tasks: service-waitress.yml

- name: Import doppovich-bot tasks
  tags: [doppovich-bot]
  ansible.builtin.import_tasks: service-doppovich-bot.yml

- name: Import venmo-auto-cashout tasks
  tags: [venmo-auto-cashout]
  ansible.builtin.import_tasks: service-venmo-auto-cashout.yml

- name: Import podman-auto-update tasks
  tags: [podman-auto-update]
  ansible.builtin.import_tasks: service-podman-auto-update.yml
